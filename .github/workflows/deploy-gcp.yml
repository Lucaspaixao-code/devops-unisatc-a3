name: Deploy to Google Cloud

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TF_WORKING_DIR: 'terraform'
  # Segredos do GitHub
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  TF_STATE_BUCKET: 'top-opus-479304-m3-terraform-state'
  
  # Variáveis para o Terraform (Sobrescrevem o terraform.tfvars)
  TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
  TF_VAR_region: ${{ secrets.GCP_REGION }}
  TF_VAR_docker_image: "lucaspaixao0/devops-strap/devops-unisatc-a3:latest"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. Checkout do código
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Autenticação no Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      # 3. Configurar Google Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 4. Ativar APIs Necessárias (Compute, Container, Resource Manager)
      - name: Enable Google Cloud APIs
        run: |
          gcloud services enable compute.googleapis.com container.googleapis.com cloudresourcemanager.googleapis.com --project=${{ env.GCP_PROJECT_ID }}

      # 5. Criar Bucket de Estado (se não existir)
      - name: Ensure Terraform State Bucket exists
        run: |
          if ! gcloud storage buckets describe gs://${{ env.TF_STATE_BUCKET }} > /dev/null 2>&1; then
            echo "Criando bucket de estado..."
            gcloud storage buckets create gs://${{ env.TF_STATE_BUCKET }} --project=${{ env.GCP_PROJECT_ID }} --location=${{ env.GCP_REGION }} --uniform-bucket-level-access
          else
            echo "Bucket já existe."
          fi

      # 6. Instalar Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      # 7. Terraform Init e Apply
      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init
          terraform apply -auto-approve -input=false

      # 8. Obter Detalhes do Cluster (Nome e Localização)
      - name: Get Cluster Details
        working-directory: ${{ env.TF_WORKING_DIR }}
        id: tf-output
        run: |
          CLUSTER_NAME=$(terraform output -raw kubernetes_cluster_name)
          CLUSTER_LOCATION=$(terraform output -raw kubernetes_cluster_location)
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "cluster_location=$CLUSTER_LOCATION" >> $GITHUB_OUTPUT

      # 9. Debug (Verificar se o cluster aparece na lista)
      - name: Debug Cluster Info
        run: |
          echo "Procurando cluster: ${{ steps.tf-output.outputs.cluster_name }} em ${{ steps.tf-output.outputs.cluster_location }}"
          gcloud container clusters list --project=${{ env.GCP_PROJECT_ID }}

      # 10. Conectar ao Cluster GKE (Com localização exata)
      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ steps.tf-output.outputs.cluster_name }}
          location: ${{ steps.tf-output.outputs.cluster_location }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # 11. Deploy da Aplicação
      - name: Deploy to GKE
        run: |
          export DOCKER_IMAGE="${{ env.TF_VAR_docker_image }}"
          # Substitui apenas a variável $DOCKER_IMAGE e aplica o YAML
          envsubst '$DOCKER_IMAGE' < k8s/deployment.yaml | kubectl apply -f -