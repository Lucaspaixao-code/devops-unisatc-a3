name: Deploy to Google Cloud

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  # Configurações centrais
  TF_WORKING_DIR: 'terraform'
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  TF_STATE_BUCKET: 'top-opus-479304-m3-terraform-state'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. Checkout do código
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Autenticação no Google Cloud (Moderna e Simples)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      # 3. Configurar Google Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 4. Criar Bucket de Estado (se não existir)
      - name: Ensure Terraform State Bucket exists
        run: |
          if ! gcloud storage buckets describe gs://${{ env.TF_STATE_BUCKET }} > /dev/null 2>&1; then
            echo "Criando bucket de estado..."
            gcloud storage buckets create gs://${{ env.TF_STATE_BUCKET }} --project=${{ env.GCP_PROJECT_ID }} --location=${{ env.GCP_REGION }} --uniform-bucket-level-access
          else
            echo "Bucket já existe."
          fi

      # 5. Instalar Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      # 6. Terraform Init e Apply (Cria Cluster e Rede)
      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init
          terraform apply -auto-approve -input=false

      # 7. Obter nome do Cluster via Output do Terraform
      - name: Get Cluster Name
        working-directory: ${{ env.TF_WORKING_DIR }}
        id: tf-output
        run: |
          CLUSTER_NAME=$(terraform output -raw kubernetes_cluster_name)
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT

      # 8. Conectar ao Cluster GKE
      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ steps.tf-output.outputs.cluster_name }}
          location: ${{ env.GCP_REGION }}

      # 9. Deploy da Aplicação no Kubernetes
      - name: Deploy to GKE
        run: |
          # Substitui a variável de imagem no YAML e aplica
          # (Assume que você quer usar a imagem definida abaixo, ou pode pegar do secrets)
          export DOCKER_IMAGE="lucaspaixao0/devops-strap/devops-unisatc-a3:latest"
          envsubst < k8s/deployment.yaml | kubectl apply -f -